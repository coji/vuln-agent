# VulnAgent: 設計ドキュメントと現状コードベースの差分分析

## 1. 概要

このドキュメントは、`.tmp/`ディレクトリにある設計ドキュメントと現在のコードベースの実装状況を比較し、主要な差分をまとめたものです。

**重要**: VulnAgentは**完全にLLMネイティブ**なセキュリティツールとして設計されています。ルールベースの実装は徹底的に排除し、すべての診断ロジックをLLMに委譲する必要があります。

## 2. 設計ドキュメント一覧

- `requirements.md` - 要件定義書
- `architecture.md` - アーキテクチャ設計書
- `tool-design.md` - Tool機能詳細設計書
- `agent-task-flow.md` - タスク管理フロー
- `html-report-design.md` - HTMLレポート機能設計書

## 3. 主要な差分と実装状況

### 3.1 アーキテクチャの差分

#### 設計（architecture.md）

```
src/
├── cli/                 # CLIインターフェース
├── core/                # コアエンジン
├── domain/              # ドメインモデル
├── infrastructure/      # HTTPクライアント、AI、ストレージ
└── tools/               # Vercel AI SDK Tools
```

#### 現状のコードベース

```
src/
├── cli/                 # ✅ 実装済み（commands/scan.ts, init.ts）
├── core/                # ✅ 実装済み（types.ts, config.ts）
├── analyzers/           # ❌ ルールベース実装（削除対象）
├── scanners/            # ⚠️ 設計とは異なる構造（Web脆弱性スキャン）
├── llm/                 # ✅ 実装済み（LLMプロバイダー統合）
├── infrastructure/http/ # ✅ 実装済み（HTTPクライアント）
├── reporters/           # ✅ 実装済み（レポート出力）
├── rules/               # ❌ ルールベース実装（削除対象）
└── utils/               # ✅ 実装済み（ロガー等）
```

**主な差分:**

- ❌ **domain層が未実装** - モデル定義が分散している
- ❌ **Vercel AI SDK Tools未使用** - 独自のLLM統合実装
- ⚠️ **構造が異なる** - analyzers/scannersに機能が分かれている
- ❌ **ルールベース実装が残存** - analyzers/とrules/は完全削除が必要

### 3.2 Tool機能の実装状況（tool-design.md）

#### 設計されたTools

| Tool名          | 設計内容                   | 実装状況                          |
| --------------- | -------------------------- | --------------------------------- |
| httpRequest     | HTTPリクエスト送信         | ⚠️ 部分的（HTTPクライアントのみ） |
| analyzeResponse | レスポンス分析             | ⚠️ 部分的（LLMによる分析あり）    |
| extractLinks    | リンク・エンドポイント抽出 | ❌ 未実装                         |
| testPayload     | ペイロードテスト           | ⚠️ 部分的（XSS/SQLi検出のみ）     |
| reportFinding   | 脆弱性報告                 | ⚠️ 部分的（レポーター機能のみ）   |
| manageTasks     | タスク管理                 | ❌ 未実装                         |
| updateStrategy  | 戦略更新                   | ❌ 未実装                         |

**主な差分:**

- ❌ **Vercel AI SDK Tool形式ではない** - 独自実装
- ❌ **自律的な探索機能なし** - 100ステップの自動探索は未実装
- ❌ **タスク管理システムなし** - エージェントの記憶保持機能なし

### 3.3 コア機能の実装状況（requirements.md）

#### 必須機能チェックリスト

- ❌ **自律探索エンジン**: LLMが最大100ステップで自律的に探索
- ✅ **HTTPリクエスト送信**: 実装済み（`infrastructure/http/client.ts`）
- ⚠️ **レスポンス分析**: 基本的な分析のみ
- ❌ **コンテンツ探索**: リンク抽出機能なし
- ❌ **SPA対応**: 実装なし
- **脆弱性検出機能**:
  - ⚠️ XSS検出: 基本実装あり
  - ⚠️ SQLインジェクション検出: 基本実装あり
  - ❌ 認証・認可の不備検出: 未実装
  - ⚠️ 設定不備・情報漏洩検出: ヘッダーチェックのみ
- ⚠️ **リアルタイム進捗表示**: 基本的な表示のみ
- ⚠️ **レポート生成**: JSON/Markdown対応、HTML未対応
- ❌ **HTMLレポート保存**: 未実装
- ✅ **CLI インターフェース**: commander.js使用

### 3.4 HTMLレポート機能（html-report-design.md）

**実装状況: ❌ 完全未実装**

設計されていた機能：

- 視覚的なHTMLレポート
- グラフ表示（Chart.js）
- Markdownコピー機能
- 単一HTMLファイル出力

現状：

- JSON/Markdown/Consoleレポートのみ
- HTMLレポート生成機能なし

### 3.5 エージェントタスク管理（agent-task-flow.md）

**実装状況: ❌ 完全未実装**

設計されていた機能：

- manageTasks Toolによるタスク管理
- 優先順位付けと動的調整
- 進捗の可視化
- エージェントの記憶保持

現状：

- 単純なスキャン実行のみ
- タスク管理システムなし

## 4. 現在の実装の特徴

### 4.1 実装済みの機能

1. **基本的なWeb脆弱性スキャン**
   - XSS検出（部分的にLLMベース、ハードコードされたペイロードあり）
   - SQLインジェクション検出（部分的にLLMベース、ハードコードされたペイロードあり）
   - セキュリティヘッダーチェック（ルールベース）

2. **LLMプロバイダー統合**
   - OpenAI (GPT-4o)
   - Anthropic (Claude Sonnet 4)
   - Google (Gemini 2.5 Pro/Flash)

3. **レポート機能**
   - Console出力
   - JSON形式
   - Markdown形式

4. **CLIインターフェース**
   - scanコマンド
   - 基本的なオプション

### 4.2 設計との主な違い

1. **アーキテクチャ**
   - Vercel AI SDK Toolsを使用していない
   - 独自のLLM統合実装
   - ドメイン駆動設計が不完全
   - **ルールベース実装が混在**

2. **自律性の欠如**
   - 100ステップの自動探索なし
   - タスク管理システムなし
   - 戦略的な診断フローなし

3. **機能の限定性**
   - エンドポイント自動発見なし
   - SPA対応なし
   - 限定的な脆弱性検出

4. **LLMネイティブではない実装**
   - 正規表現パターンマッチング（pattern-matcher.ts）
   - 静的ルールセット（default-rules.ts）
   - ハードコードされたペイロード
   - 固定的なセキュリティヘッダーチェック

## 5. 推奨される次のステップ

### 5.1 優先度最高 - ルールベース実装の完全削除

1. **削除対象ファイル・ディレクトリ**
   - `src/analyzers/` - 正規表現ベースの解析機能全体
   - `src/rules/` - 静的ルールセット全体
   - セキュリティヘッダーチェックのハードコード部分

2. **リファクタリング対象**
   - `src/scanners/vulnerabilities/` - ハードコードされたペイロードをLLM生成に変更
   - XSS/SQLi検出器 - 完全にLLMベースに書き換え

### 5.2 優先度高 - LLMネイティブアーキテクチャの実装

1. **Vercel AI SDK Tools統合**
   - 設計通りの7つのTool実装
   - 自律的な探索機能

2. **タスク管理システム実装**
   - manageTasks Tool
   - エージェントの状態管理
   - 100ステップの自律探索

3. **完全LLM駆動の脆弱性検出**
   - すべての検出ロジックをLLMに委譲
   - 動的ペイロード生成
   - コンテキスト依存の分析

### 5.3 優先度中

1. **HTMLレポート機能**
   - 設計通りの視覚的レポート
   - 単一HTMLファイル出力

2. **エンドポイント発見機能**
   - extractLinks Tool実装（LLMベース）
   - SPA対応

3. **ドメイン層の整理**
   - モデル定義の統一
   - 設計通りのレイヤー構造

### 5.4 優先度低

1. **並列診断機能**
2. **プラグインシステム**
3. **GUI/Web UI**

## 6. まとめ

現在のコードベースは、設計ドキュメントで計画された**LLMネイティブ**なビジョンから大きく乖離しています：

### 最重要課題

1. **ルールベース実装の混在** - 正規表現、静的ルール、ハードコードされたロジックが残存
2. **自律性の欠如** - AIエージェントによる自律的な診断が未実装
3. **Tool設計の未採用** - Vercel AI SDK Toolsを使用していない

### LLMネイティブ化への必須アクション

1. **即座に削除すべきもの**
   - `src/analyzers/` ディレクトリ全体
   - `src/rules/` ディレクトリ全体
   - すべてのハードコードされたペイロードとパターン

2. **完全に書き換えるべきもの**
   - 脆弱性検出ロジック → 100% LLM駆動
   - セキュリティチェック → LLMによる動的分析
   - ペイロード生成 → LLMによる文脈依存生成

設計ドキュメントのビジョンである「**完全にLLMネイティブな自律型セキュリティツール**」を実現するには、既存のルールベース実装を完全に排除し、Vercel AI SDK Toolsを中心とした再実装が必要です。

これは単なるリファクタリングではなく、**アーキテクチャの根本的な転換**です。

## 7. 発見されたルールベース実装の詳細

### 7.1 pattern-matcher.ts

- 正規表現によるパターンマッチング機能
- 行・列番号の計算ロジック
- 静的なルールに基づく脆弱性検出

### 7.2 default-rules.ts

以下のハードコードされたルール:

- `hardcoded-secret` - APIキーやパスワードの正規表現検出
- `sql-injection` - SQLインジェクションの正規表現パターン
- `eval-usage` - eval()使用の検出
- `weak-crypto` - MD5/SHA1の検出
- `insecure-random` - Math.random()の検出

### 7.3 その他のルールベース実装

- セキュリティヘッダーのハードコードチェック（web-scanner.ts）
- XSS/SQLiの固定ペイロード（scanners/vulnerabilities/）

これらはすべて**LLMによる動的分析に置き換える必要があります**。
